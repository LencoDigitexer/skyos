#include "sched.h"
#include "devices.h"

#define O 0xff
#define W 0x0f
#define B 0x00

int mouse_x, mouse_y;
int old_x, old_y;
int mouse_but1, mouse_but2;

int bytenum;
unsigned char combytes[3];  // Microsoft standard

unsigned char back[256];

unsigned char cursor_mask[256] =
{0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};


/*
{B,B,O,O,O,O,O,O,O,O,O,O,O,O,O,O,
 B,W,B,O,O,O,O,O,O,O,O,O,O,O,O,O,
 B,W,W,B,O,O,O,O,O,O,O,O,O,O,O,O,
 B,W,W,W,B,O,O,O,O,O,O,O,O,O,O,O,
 B,W,W,W,W,B,O,O,O,O,O,O,O,O,O,O,
 B,W,W,W,W,W,B,O,O,O,O,O,O,O,O,O,
 B,W,W,W,W,W,W,B,O,O,O,O,O,O,O,O,
 B,W,W,W,W,W,W,W,B,O,O,O,O,O,O,O,
 B,W,W,W,W,W,W,B,B,O,O,O,O,O,O,O,
 B,W,W,W,W,W,B,O,O,O,O,O,O,O,O,O,
 B,W,W,W,W,W,B,B,O,O,O,O,O,O,O,O,
 B,W,W,W,W,W,W,W,B,O,O,O,O,O,O,O,
 B,W,W,B,B,W,W,W,W,B,O,O,O,O,O,O,
 B,W,B,O,O,B,W,W,B,O,O,O,O,O,O,O,
 B,B,O,O,O,O,B,B,O,O,O,O,O,O,O,O,
 O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O};
*/

void mouse_interrupt(void)
{
  int flags;
  unsigned char inbyte;
  int dx, dy;

//  save_flags(flags);
//  cli();

  inbyte = inportb(0x3f8);

  // Make sure we are properly "synched"
  if ((inbyte & 64) == 64)
    bytenum = 0;

  // Store the byte and adjust bytenum
  combytes[bytenum] = inbyte;
  bytenum++;

  if (bytenum == 3)
  {
    dx = ((combytes[0] & 3) << 6) + combytes[1];
    dy = ((combytes[0] & 12) << 4) + combytes[2];
    if (dx >= 128) dx = dx - 256;
    if (dy >= 128) dy = dy - 256;
    old_x = mouse_x;
    old_y = mouse_y;

    mouse_x += dx;
    mouse_y += dy;
    mouse_but1 = (combytes[0] & 32) != 0;
    mouse_but2 = (combytes[0] & 16) != 0;
    bytenum = 0;

    if (mouse_x < 0) mouse_x = 0;
    if (mouse_y < 0) mouse_y = 0;
    if (mouse_x > 1023) mouse_x = 1023;
    if (mouse_y > 767) mouse_y = 767;

//    printk("x: %3d  y: %3d  but1: %2d  but2: %2d",mouse_x, mouse_y, mouse_but1, mouse_but2);
    draw_cursor();
  }

//  printk("  %3d  %3d  %3d  %3d  %3d  %3d  %3d  %3d",inportb(0x3f8),inportb(0x3f9),inportb(0x3fa),inportb(0x3fb),inportb(0x3fc),inportb(0x3fd),inportb(0x3fe),inportb(0x3ff));

//  restore_flags(flags);
}

void save_back()
{
  int i,j;

  for (j=0;j<16;j++)
    for (i=0;i<16;i++)
      back[j*16+i] = get_pixel(mouse_x+i,mouse_y+j);

}

void restore_back()
{
  int i,j;

  for (j=0;j<16;j++)
    for (i=0;i<16;i++)
      put_pixel(old_x+i,old_y+j,back[j*16+i]);

}

void draw_cursor()
{
  int i,j;

  restore_back();
  save_back();

  for (j=0;j<16;j++)
    for (i=0;i<16;i++)
    {
      if (cursor_mask[j*16+i] != 0xff)
        put_pixel(mouse_x+i,mouse_y+j,cursor_mask[j*16+i]);
    }
}

void mouse_init()
{
  int timeout = 0;

//  console_clear();

  outportb(0x3f8 + 1 , 0);
  outportb(0x3f8 + 3 , 0x80);

  outportb(0x3f8+0x03,inportb(0x03) | 0x80);
  outportb(0x3f8+0x00,0x60);
  outportb(0x3f8+0x01,0);
  outportb(0x3f8+0x03,inportb(0x03) & ~0x80);

  outportb(0x3f8 + 3 , 0x02); // 0x06
  inportb(0x3f8);

  outportb(0x3f8 + 4 , 0x0b);  // 0x09

  while ((timeout++ < 100000) && (inportb(0x3f8) != 'M')) ;
  if (timeout == 100000)
    printk("No Microsoft compatible mouse found");
  else
    printk("Microsoft compatible mouse found");

  timeout = 0;
  while ((timeout++ < 100000) && (inportb(0x3f8) != 0x09)) ;
  if (timeout == 100000)
    printk("Error while initialisizing mouse");

  outportb(0x21,(inportb(0x21) & 0xEF));
  outportb(0x3f8 + 1 , 0x01);

  mouse_reset();
}

void mouse_reset()
{
  mouse_x = mouse_y = 200;
  old_x = old_y = 200;
  mouse_but1 = mouse_but2 = 0;
  bytenum = 0;

  save_back();
}
