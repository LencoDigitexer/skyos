/************************************************************************/
/* Sky Operating System V2
/* Copyright (c) 1996 by Szeleney Robert
/*
/* Project Members: Szeleney Robert
/*                  Resl Christian
/*                  Hayrapetian Gregory
/************************************************************************/
/* File       : kernel\vga.c
/* Last Update: 04.11.1998
/* Version    : beta
/* Coded by   : Szeleney Robert
/* Docus from :
/************************************************************************/
/* Definition:
/*   Functions to access a VGA Card. Very slow routines. This file is
/*   used temporaly until SVGA Drivers are coded.
/************************************************************************/
#include <stdarg.h>

typedef struct box
{
  int x1, y1, x2, y2;
} box_t;

unsigned char char_tab2[257*8] = {
	  0,0,0,0,0,0,0,0,
	  126,129,165,129,189,153,129,126,
	  126,255,219,255,195,231,255,126,
	  108,254,254,254,124,56,16,0,
	  16,56,124,254,124,56,16,0,
	  56,124,56,254,254,146,16,124,
	  0,16,56,124,254,124,56,124,
	  0,0,24,60,60,24,0,0,
	  255,255,231,195,195,231,255,255,
	  0,60,102,66,66,102,60,0,
	  255,195,153,189,189,153,195,255,
	  15,7,15,125,204,204,204,120,
	  60,102,102,102,60,24,126,24,
	  63,51,63,48,48,112,240,224,
	  127,99,127,99,99,103,230,192,
	  153,90,60,231,231,60,90,153,
	  128,224,248,254,248,224,128,0,
	  2,14,62,254,62,14,2,0,
	  24,60,126,24,24,126,60,24,
	  102,102,102,102,102,0,102,0,
	  127,219,219,123,27,27,27,0,
	  62,99,56,108,108,56,134,252,
	  0,0,0,0,126,126,126,0,
	  24,60,126,24,126,60,24,255,
	  24,60,126,24,24,24,24,0,
	  24,24,24,24,126,60,24,0,
	  0,24,12,254,12,24,0,0,
	  0,48,96,254,96,48,0,0,
	  0,0,192,192,192,254,0,0,
	  0,36,102,255,102,36,0,0,
	  0,24,60,126,255,255,0,0,
	  0,255,255,126,60,24,0,0,
	  0,0,0,0,0,0,0,0,
	  24,60,60,24,24,0,24,0,
	  108,108,108,0,0,0,0,0,
	  108,108,254,108,254,108,108,0,
	  24,126,192,124,6,252,24,0,
	  0,198,204,24,48,102,198,0,
	  56,108,56,118,220,204,118,0,
	  48,48,96,0,0,0,0,0,
	  24,48,96,96,96,48,24,0,
	  96,48,24,24,24,48,96,0,
	  0,102,60,255,60,102,0,0,
	  0,24,24,126,24,24,0,0,
	  0,0,0,0,0,24,24,48,
	  0,0,0,126,0,0,0,0,
	  0,0,0,0,0,24,24,0,
	  6,12,24,48,96,192,128,0,
	  124,198,214,214,214,198,124,0,
	  48,112,48,48,48,48,252,0,
	  120,204,12,56,96,204,252,0,
	  120,204,12,56,12,204,120,0,
	  28,60,108,204,254,12,30,0,
	  252,192,248,12,12,204,120,0,
	  56,96,192,248,204,204,120,0,
	  252,204,12,24,48,48,48,0,
	  120,204,204,120,204,204,120,0,
	  120,204,204,124,12,24,112,0,
	  0,24,24,0,0,24,24,0,
	  0,24,24,0,0,24,24,48,
	  24,48,96,192,96,48,24,0,
	  0,0,126,0,126,0,0,0,
	  96,48,24,12,24,48,96,0,
	  60,102,12,24,24,0,24,0,
	  124,198,222,222,220,192,124,0,
	  48,120,204,204,252,204,204,0,
	  252,102,102,124,102,102,252,0,
	  60,102,192,192,192,102,60,0,
	  248,108,102,102,102,108,248,0,
	  254,98,104,120,104,98,254,0,
	  254,98,104,120,104,96,240,0,
	  60,102,192,192,206,102,58,0,
	  204,204,204,252,204,204,204,0,
	  120,48,48,48,48,48,120,0,
	  30,12,12,12,204,204,120,0,
	  230,102,108,120,108,102,230,0,
	  240,96,96,96,98,102,254,0,
	  198,238,254,254,214,198,198,0,
	  198,230,246,222,206,198,198,0,
	  56,108,198,198,198,108,56,0,
	  252,102,102,124,96,96,240,0,
	  124,198,198,198,214,124,14,0,
	  252,102,102,124,108,102,230,0,
	  124,198,224,120,14,198,124,0,
	  252,180,48,48,48,48,120,0,
	  204,204,204,204,204,204,252,0,
	  204,204,204,204,204,120,48,0,
	  198,198,198,198,214,254,108,0,
	  198,198,108,56,108,198,198,0,
	  204,204,204,120,48,48,120,0,
	  254,198,140,24,50,102,254,0,
	  120,96,96,96,96,96,120,0,
	  192,96,48,24,12,6,2,0,
	  120,24,24,24,24,24,120,0,
	  16,56,108,198,0,0,0,0,
	  0,0,0,0,0,0,0,255,
	  48,48,24,0,0,0,0,0,
	  0,0,120,12,124,204,118,0,
	  224,96,96,124,102,102,220,0,
	  0,0,120,204,192,204,120,0,
	  28,12,12,124,204,204,118,0,
	  0,0,120,204,252,192,120,0,
	  56,108,100,240,96,96,240,0,
	  0,0,118,204,204,124,12,248,
	  224,96,108,118,102,102,230,0,
	  48,0,112,48,48,48,120,0,
	  12,0,28,12,12,204,204,120,
	  224,96,102,108,120,108,230,0,
	  112,48,48,48,48,48,120,0,
	  0,0,204,254,254,214,214,0,
	  0,0,184,204,204,204,204,0,
	  0,0,120,204,204,204,120,0,
	  0,0,220,102,102,124,96,240,
	  0,0,118,204,204,124,12,30,
	  0,0,220,118,98,96,240,0,
	  0,0,124,192,112,28,248,0,
	  16,48,252,48,48,52,24,0,
	  0,0,204,204,204,204,118,0,
	  0,0,204,204,204,120,48,0,
	  0,0,198,198,214,254,108,0,
	  0,0,198,108,56,108,198,0,
	  0,0,204,204,204,124,12,248,
	  0,0,252,152,48,100,252,0,
	  28,48,48,224,48,48,28,0,
	  24,24,24,0,24,24,24,0,
	  224,48,48,28,48,48,224,0,
	  118,220,0,0,0,0,0,0,
	  0,16,56,108,198,198,254,0,
	  124,198,192,198,124,12,6,124,
	  0,204,0,204,204,204,118,0,
	  28,0,120,204,252,192,120,0,
	  126,129,60,6,62,102,59,0,
	  204,0,120,12,124,204,118,0,
	  224,0,120,12,124,204,118,0,
	  48,48,120,12,124,204,118,0,
	  0,0,124,198,192,120,12,56,
	  126,129,60,102,126,96,60,0,
	  204,0,120,204,252,192,120,0,
	  224,0,120,204,252,192,120,0,
	  204,0,112,48,48,48,120,0,
	  124,130,56,24,24,24,60,0,
	  224,0,112,48,48,48,120,0,
	  198,16,124,198,254,198,198,0,
	  48,48,0,120,204,252,204,0,
	  28,0,252,96,120,96,252,0,
	  0,0,127,12,127,204,127,0,
	  62,108,204,254,204,204,206,0,
	  120,132,0,120,204,204,120,0,
	  0,204,0,120,204,204,120,0,
	  0,224,0,120,204,204,120,0,
	  120,132,0,204,204,204,118,0,
	  0,224,0,204,204,204,118,0,
	  0,204,0,204,204,124,12,248,
	  195,24,60,102,102,60,24,0,
	  204,0,204,204,204,204,120,0,
	  24,24,126,192,192,126,24,24,
	  56,108,100,240,96,230,252,0,
	  204,204,120,48,252,48,252,48,
	  248,204,204,250,198,207,198,195,
	  14,27,24,60,24,24,216,112,
	  28,0,120,12,124,204,118,0,
	  56,0,112,48,48,48,120,0,
	  0,28,0,120,204,204,120,0,
	  0,28,0,204,204,204,118,0,
	  0,248,0,184,204,204,204,0,
	  252,0,204,236,252,220,204,0,
	  60,108,108,62,0,126,0,0,
	  56,108,108,56,0,124,0,0,
	  24,0,24,24,48,102,60,0,
	  0,0,0,252,192,192,0,0,
	  0,0,0,252,12,12,0,0,
	  198,204,216,54,107,194,132,15,
	  195,198,204,219,55,109,207,3,
	  24,0,24,24,60,60,24,0,
	  0,51,102,204,102,51,0,0,
	  0,204,102,51,102,204,0,0,
	  34,136,34,136,34,136,34,136,
	  85,170,85,170,85,170,85,170,
	  221,119,221,119,221,119,221,119,
	  24,24,24,24,24,24,24,24,
	  24,24,24,24,248,24,24,24,
	  24,24,248,24,248,24,24,24,
	  54,54,54,54,246,54,54,54,
	  0,0,0,0,254,54,54,54,
	  0,0,248,24,248,24,24,24,
	  54,54,246,6,246,54,54,54,
	  54,54,54,54,54,54,54,54,
	  0,0,254,6,246,54,54,54,
	  54,54,246,6,254,0,0,0,
	  54,54,54,54,254,0,0,0,
	  24,24,248,24,248,0,0,0,
	  0,0,0,0,248,24,24,24,
	  24,24,24,24,31,0,0,0,
	  24,24,24,24,255,0,0,0,
	  0,0,0,0,255,24,24,24,
	  24,24,24,24,31,24,24,24,
	  0,0,0,0,255,0,0,0,
	  24,24,24,24,255,24,24,24,
	  24,24,31,24,31,24,24,24,
	  54,54,54,54,55,54,54,54,
	  54,54,55,48,63,0,0,0,
	  0,0,63,48,55,54,54,54,
	  54,54,247,0,255,0,0,0,
	  0,0,255,0,247,54,54,54,
	  54,54,55,48,55,54,54,54,
	  0,0,255,0,255,0,0,0,
	  54,54,247,0,247,54,54,54,
	  24,24,255,0,255,0,0,0,
	  54,54,54,54,255,0,0,0,
	  0,0,255,0,255,24,24,24,
	  0,0,0,0,255,54,54,54,
	  54,54,54,54,63,0,0,0,
	  24,24,31,24,31,0,0,0,
	  0,0,31,24,31,24,24,24,
	  0,0,0,0,63,54,54,54,
	  54,54,54,54,255,54,54,54,
	  24,24,255,24,255,24,24,24,
	  24,24,24,24,248,0,0,0,
	  0,0,0,0,31,24,24,24,
	  255,255,255,255,255,255,255,255,
	  0,0,0,0,255,255,255,255,
	  240,240,240,240,240,240,240,240,
	  15,15,15,15,15,15,15,15,
	  255,255,255,255,0,0,0,0,
	  0,0,118,220,200,220,118,0,
	  124,198,198,204,198,195,206,0,
	  0,252,204,192,192,192,192,0,
	  0,0,254,108,108,108,108,0,
	  252,204,96,48,96,204,252,0,
	  0,0,126,216,216,216,112,0,
	  0,102,102,102,102,124,96,192,
	  0,118,220,24,24,24,24,0,
	  252,48,120,204,204,120,48,252,
	  56,108,198,254,198,108,56,0,
	  56,108,198,198,108,108,238,0,
	  28,48,24,124,204,204,120,0,
	  0,0,126,219,219,126,0,0,
	  6,12,126,219,219,126,96,192,
	  56,96,192,248,192,96,56,0,
	  120,204,204,204,204,204,204,0,
	  0,126,0,126,0,126,0,0,
	  24,24,126,24,24,0,126,0,
	  96,48,24,48,96,0,252,0,
	  24,48,96,48,24,0,252,0,
	  14,27,27,24,24,24,24,24,
	  24,24,24,24,24,216,216,112,
	  24,24,0,126,0,24,24,0,
	  0,118,220,0,118,220,0,0,
	  56,108,108,56,0,0,0,0,
	  0,0,0,24,24,0,0,0,
	  0,0,0,0,24,0,0,0,
	  15,12,12,12,236,108,60,28,
	  88,108,108,108,108,0,0,0,
	  112,152,48,96,248,0,0,0,
	  0,0,60,60,60,60,0,0,
	  0,0,0,0,0,0,0,0,
	  0,0,0,0,0,0,0,0};

int abs(int x)
{
  if (x < 0)
  {
    x *= -1;
  }return x;
}

void line(int x1, int y1, int x2, int y2, unsigned char color)
{
  int i, deltax, deltay, numpixels,
    d, dinc1, dinc2,
    x, xinc1, xinc2,
    y, yinc1, yinc2;

  deltax = abs(x2 - x1);
  deltay = abs(y2 - y1);

  if (deltax >= deltay)
  {
      numpixels = deltax + 1;
      d = (2 * deltay) - deltax;
      dinc1 = deltay << 1;
      dinc2 = (deltay - deltax) << 1;
      xinc1 = 1;
      xinc2 = 1;
      yinc1 = 0;
      yinc2 = 1;
  }
  else
  {
      numpixels = deltay + 1;
      d = (2 * deltax) - deltay;
      dinc1 = deltax << 1;
      dinc2 = (deltax - deltay) << 1;
      xinc1 = 0;
      xinc2 = 1;
      yinc1 = 1;
      yinc2 = 1;
  }
  if (x1 > x2)
  {
      xinc1 = - xinc1;
      xinc2 = - xinc2;
  }
  if (y1 > y2)
  {
      yinc1 = - yinc1;
      yinc2 = - yinc2;
  }
  x = x1;
  y = y1;

  for (i=1;i<=numpixels;i++)
  {
     setpix(x, y, color);
      if (d < 0)
      {
	  d = d + dinc1;
	  x = x + xinc1;
	  y = y + yinc1;
      }
      else
      {
	  d = d + dinc2;
	  x = x + xinc2;
	  y = y + yinc2;
      }
  }
}

void rect(int x1, int y1, int x2, int y2, unsigned char col)
{
  int i;

  for (i=x1;i<=x2;i++)
  {
    setpix(i,y1,col);
    setpix(i,y2,col);
  }
  for (i=y1;i<=y2;i++)
  {
    setpix(x1,i,col);
    setpix(x2,i,col);
  }
}

void box(int x1, int y1, int x2, int y2, unsigned char c1, unsigned char c2, unsigned char c3)
{
  int i;
  int j;

  for (i=x1;i<=x2;i++)
    for (j=y1;j<=y2;j++)
      setpix(i,j,c2);

  for (i=x1;i<=x2;i++)
  {
    setpix(i,y1,c1);
    setpix(i,y2,c3);
  }
  for (i=y1;i<=y2;i++)
  {
    setpix(x1,i,c1);
    setpix(x2,i,c3);
  }
}

void X_outch(unsigned char ch, int x, int y, unsigned char vg, unsigned char hg)
{
  int i,k;

  unsigned char maske;

  if (ch<30) return;

  if (hg==255)
  {
    for (i=0;i<8;i++)
    {
      maske = char_tab2[ch*8+i];
      for (k=0; k<8;++k,maske <<=1)
      if (maske & 128)
	setpix(x+k,y+i,vg);
    }
  }
}

void outs(int x, int y, unsigned char col, char *string,...)
{
  va_list parameter;
  char outstring[255], *cp;

  va_start(parameter, string);
  vsprintf(outstring,string,parameter);
  for (cp = outstring;*cp;++cp,x+=8)
      X_outch(*cp,x,y,col,255);
}

void outs_c(int x1, int x2, int y, unsigned char col, char *string,...)
{
  int newx;
  va_list parameter;
  char outstring[255], *cp;

  newx = (x1+x2)/2 - (strlen(string)*4);

  va_start(parameter, string);
  vsprintf(outstring,string,parameter);
  for (cp = outstring;*cp;++cp,newx+=8)
    X_outch(*cp,newx,y,col,255);

}

void outs_l(int x, int y, unsigned char col, char *string,...)
{
  int newx;
  va_list parameter;
  char outstring[255], *cp;

  newx = x - (strlen(string)*8);

  va_start(parameter, string);
  vsprintf(outstring,string,parameter);
  for (cp = outstring;*cp;++cp,newx+=8)
    X_outch(*cp,newx,y,col,255);

}


/* Clipping functions for newgui */


void X_outch_c(box_t *box, unsigned char ch, int x, int y, unsigned char vg, unsigned char hg)
{
  int i,k;
  int sx=0, sy=0, dx=7, dy=7;

  unsigned char maske;

  if (ch<30) return;
/*
  if (x > box->x2) return;
  if (y > box->y2) return;
  if ((x+dx) < box->x1) return;
  if ((y+dy) < box->y1) return;
*/
/*
  if (x < box->x1) sx = box->x1-x;
  if (y < box->y1) sy = box->y1-y;
  if (x > box->x1) sx = x-box->x1;
  if (y > box->y1) sy = y-box->y1;

  if ((x+dx) > box->x2) dx = 7-((x+dx)-box->x2);
  if ((y+dy) > box->y2) dy = 7-((y+dy)-box->y2);
*/
  if (hg==255)
  {
    for (i=sy;i<=dy;i++)
    {
      maske = char_tab2[ch*8+i];
      for (k=sx; k<=dx;++k,maske <<=1)
      if (maske & 128)
      {
	if (((x+k) >= box->x1) && ((y+i) >= box->y1) && ((x+k) <= box->x2) && ((y+i) <= box->y2))
	  setpix(x+k,y+i,vg);
      }
    }
  }
}

void outs_cc(box_t *box, int x, int y, unsigned char col, char *string,...)
{
  va_list parameter;
  char outstring[255], *cp;
/*
  if (box->x1 < 0) box->x1 = 0;
  if (box->y1 < 0) box->y1 = 0;
  if (box->x2 > 1023) box->x2 = 1023;
  if (box->y2 > 1023) box->y2 = 1023;
*/

  va_start(parameter, string);
  vsprintf(outstring,string,parameter);
  for (cp = outstring;*cp;++cp,x+=8)
  {
    if (((x+7) > box->x1) && ((y+7) > box->y1) && (x < box->x2) && (y < box->y2))
      X_outch_c(box,*cp,x,y,col,255);
  }
}

